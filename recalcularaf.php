function recalcularafiliados(PDO $pdo)<?php 
{<?php $padrao =<?php (float)$pdo->query("SELECT revshare_padrao FROM config LIMIT 1")->fetchColumn();<?php <?php $stmt =<?php $pdo->query("<?php SELECT <?php o.user_id,<?php o.resultado,<?php r.valor AS custo,<?php u.indicacao,<?php a.id AS afiliado_id,<?php a.comissao_revshare <?php FROM orders o <?php JOIN raspadinhas r ON r.id =<?php o.raspadinha_id <?php JOIN usuarios u ON u.id =<?php o.user_id <?php JOIN usuarios a ON a.id =<?php u.indicacao <?php WHERE o.status =<?php 1 AND a.influencer =<?php 1 <?php ");<?php <?php $dados =<?php [];<?php <?php while ($row =<?php $stmt->fetch(PDO::FETCH_ASSOC))<?php {<?php $id =<?php (int)$row['afiliado_id'];<?php $pct =<?php (float)$row['comissao_revshare']<?php ?:<?php $padrao;<?php $custo =<?php (float)$row['custo'];<?php $perda =<?php $row['resultado']<?php ===<?php 'gain'<?php ?<?php -$custo :<?php $custo;<?php $comissao =<?php ($perda *<?php $pct)<?php /<?php 100;<?php <?php if (!isset($dados[$id]))<?php $dados[$id]<?php =<?php 0;<?php $dados[$id]<?php +=<?php $comissao;<?php }<?php <?php if (!empty($dados))<?php {<?php $ids =<?php implode(',',<?php array_keys($dados));<?php $pdo->exec("UPDATE usuarios SET saldo =<?php 0 WHERE influencer =<?php 1 AND id IN ($ids)");<?php }<?php <?php $up =<?php $pdo->prepare("UPDATE usuarios SET saldo =<?php ?<?php WHERE id =<?php ?");<?php foreach ($dados as $id =><?php $valor)<?php {<?php $up->execute([round($valor,<?php 2),<?php $id]);<?php }<?php <?php echo "finalizado";<?php 
}<?php 
